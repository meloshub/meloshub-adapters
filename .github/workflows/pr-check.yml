name: Adapter PR Check & Notification

on:
  pull_request:
    branches:
      - main
      
      
jobs:
  validate-and-notify:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      # æ£€å‡º main åˆ†æ”¯çš„ä»£ç 
      - name: Checkout main branch for comparison
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: main-branch

      # æ£€å‡º PR åˆ†æ”¯çš„å½“å‰ä»£ç 
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          path: pr-branch

      # è®¾ç½® Go ç¯å¢ƒ
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      # è¿è¡Œå·¥å…·ç”Ÿæˆå…ƒæ•°æ®å’Œall.goæ–‡ä»¶
      - name: Run Auto-Generation Tools
        run: |
          cd pr-branch
          # è¿è¡Œ metadata.yaml ç”Ÿæˆå™¨
          go run ./tools/metagen/main.go --output adapters.yaml
          # è¿è¡Œ all.go ç”Ÿæˆå™¨
          go run ./tools/autoimport/main.go --output ./all/all.go --pkg all

      # è‡ªåŠ¨æäº¤ä¸¤ä¸ªæ–‡ä»¶çš„å˜æ›´
      - name: Commit and push generated files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          working_directory: pr-branch 
          commit_message: "chore(ci): auto-generate adapter files"
          # åŒ¹é…æ‰€æœ‰éœ€è¦è‡ªåŠ¨æäº¤çš„æ–‡ä»¶
          file_pattern: "adapters.yaml all/all.go" 
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"

      # è¿è¡Œ differ å·¥å…·ç”Ÿæˆå˜æ›´æŠ¥å‘Š
      - name: Generate Change Report
        id: differ
        run: |
          cd pr-branch
          go run ./tools/differ/main.go \
            --old ../main-branch/adapters.yaml \
            --new ./adapters.yaml \
            --output changes.json

      # ä½¿ç”¨å˜æ›´æŠ¥å‘Šå‘å¸ƒPRè¯„è®º
      - name: Post Update Notification Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = './pr-branch/changes.json';
            
            if (!fs.existsSync(path)) {
              console.log('Change report not found, skipping comment.');
              return;
            }

            const changes = JSON.parse(fs.readFileSync(path, 'utf8'));
            let body = '### ğŸ¤– Meloshub Adapter Change Report\n\n';
            let hasChanges = false;

            if (changes.added && changes.added.length > 0) {
              hasChanges = true;
              body += '#### âœ¨ New Adapters\n';
              for (const a of changes.added) {
                body += `- **${a.title}** (ID: \`${a.id}\`, Version: \`${a.version}\`)\n`;
              }
            }

            if (changes.updated && changes.updated.length > 0) {
              hasChanges = true;
              body += '#### â¬†ï¸ Updated Adapters\n';
              for (const u of changes.updated) {
                body += `- **${u.after.title}** (ID: \`${u.after.id}\`)\n`;
                body += `  - Version: \`${u.before.version}\` â†’ \`${u.after.version}\`\n`;
              }
            }

            if (changes.removed && changes.removed.length > 0) {
              hasChanges = true;
              body += '#### ğŸ—‘ï¸ Removed Adapters\n';
              for (const r of changes.removed) {
                body += `- **${r.title}** (ID: \`${r.id}\`)\n`;
              }
            }

            if (!hasChanges) {
              body += 'âœ… No changes detected in adapter metadata.';
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });