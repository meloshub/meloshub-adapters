name: Adapter PR Check & Notification

on:
  pull_request:
    branches:
      - main
      
      
jobs:
  validate-and-notify:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
      issues: write

    steps:
      # æ£€å‡º main åˆ†æ”¯çš„ä»£ç 
      - name: Checkout main branch for comparison
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: main-branch

      # æ£€å‡º PR åˆ†æ”¯çš„å½“å‰ä»£ç 
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          path: pr-branch

      # è®¾ç½® Go ç¯å¢ƒ
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      # è¿è¡Œå·¥å…·ç”Ÿæˆå…ƒæ•°æ®å’Œall.goæ–‡ä»¶
      - name: Run Auto-Generation Tools
        run: |
          cd pr-branch
          # è¿è¡Œ metadata.yaml ç”Ÿæˆå™¨
          go run github.com/meloshub/meloshub-tools/cmd/metagen@latest --output adapters.yaml
          # è¿è¡Œ all.go ç”Ÿæˆå™¨
          go run github.com/meloshub/meloshub-tools/cmd/autoimport@latest --output ./all/all.go --pkg all

      # è¿è¡Œ differ å·¥å…·ç”Ÿæˆå˜æ›´æŠ¥å‘Š
      - name: Generate Change Report
        id: differ
        run: |
          go run github.com/meloshub/meloshub-tools/cmd/differ@latest \
            --old ../main-branch/adapters.yaml \
            --new ./pr-branch/adapters.yaml \
            --output ./pr-branch/changes.json

      # è‡ªåŠ¨æäº¤ä¸¤ä¸ªæ–‡ä»¶çš„å˜æ›´
      - name: Commit and push generated files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          working_directory: pr-branch 
          commit_message: "chore(ci): auto-generate adapter files"
          file_pattern: "adapters.yaml all/all.go" 
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"

      # æ ¹æ®å˜æ›´æŠ¥å‘Šæ·»åŠ æ ‡ç­¾å¹¶å‘å¸ƒè¯„è®º
      - name: Add Labels and Post Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = './pr-branch/changes.json';
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;

            if (!fs.existsSync(path)) {
              console.log('Change report not found, skipping labels and comment.');
              return;
            }

            const changes = JSON.parse(fs.readFileSync(path, 'utf8'));
            
            // åŠ¨æ€æ ‡ç­¾

            const labelConfig = {
              'NewAdapter': { color: '0e8a16', description: 'PR adds one or more new adapters.' },       // ç»¿è‰²
              'UpgradeAdapter': { color: '0075ca', description: 'PR upgrades one or more existing adapters.' }, // è“è‰²
              'RemoveAdapter': { color: 'b60205', description: 'PR removes one or more adapters.' }     // çº¢è‰²
            };

            // ç¡®ä¿æ ‡ç­¾å­˜åœ¨çš„å‡½æ•°
            async function ensureLabelExists(name) {
              const config = labelConfig[name];
              try {
                await github.rest.issues.getLabel({ owner, repo, name });
              } catch (error) {
                if (error.status === 404) {
                  console.log(`Label '${name}' not found. Creating it...`);
                  await github.rest.issues.createLabel({ owner, repo, name, ...config });
                } else {
                  throw error;
                }
              }
            }

            const labelsToAdd = [];
            if (changes.added && changes.added.length > 0) {
              labelsToAdd.push('NewAdapter');
            }
            if (changes.updated && changes.updated.length > 0) {
              labelsToAdd.push('UpgradeAdapter');
            }
            if (changes.removed && changes.removed.length > 0) {
              labelsToAdd.push('RemoveAdapter');
            }

            if (labelsToAdd.length > 0) {
              // ç¡®ä¿æ‰€æœ‰éœ€è¦çš„æ ‡ç­¾éƒ½å­˜åœ¨
              for (const labelName of labelsToAdd) {
                await ensureLabelExists(labelName);
              }
              // ä¸ºPRæ·»åŠ æ ‡ç­¾
              await github.rest.issues.addLabels({ owner, repo, issue_number, labels: labelsToAdd });
              console.log(`Added labels: ${labelsToAdd.join(', ')}`);
            }
            
            // --- è¯„è®ºç”Ÿæˆä¸å‘å¸ƒé€»è¾‘ ---

            let body = '### ğŸ¤– Meloshub Adapter Change Report\n\n';
            let hasChanges = false;

            if (changes.added && changes.added.length > 0) {
              hasChanges = true;
              body += '#### âœ¨ New Adapters\n';
              for (const a of changes.added) {
                body += `- **${a.title}** (ID: \`${a.id}\`, Version: \`${a.version}\`)\n`;
              }
            }

            if (changes.updated && changes.updated.length > 0) {
              hasChanges = true;
              body += '#### â¬†ï¸ Upgraded Adapters\n';
              for (const u of changes.updated) {
                body += `- **${u.after.title}** (ID: \`${u.after.id}\`)\n`;
                body += `  - Version: \`${u.before.version}\` â†’ \`${u.after.version}\`\n`;
              }
            }

            if (changes.removed && changes.removed.length > 0) {
              hasChanges = true;
              body += '#### ğŸ—‘ï¸ Removed Adapters\n';
              for (const r of changes.removed) {
                body += `- **${r.title}** (ID: \`${r.id}\`)\n`;
              }
            }

            if (!hasChanges) {
              body += 'âœ… No changes detected in adapter metadata.';
            }

            await github.rest.issues.createComment({ owner, repo, issue_number, body });