name: Adapter PR Check & Notification

on:
  pull_request:
    branches:
      - main
      
      
jobs:
  validate-and-notify:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
      issues: write

    steps:
      # 检出 main 分支的代码
      - name: Checkout main branch for comparison
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: main-branch

      # 检出 PR 分支的当前代码
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          path: pr-branch

      # 设置 Go 环境
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      # 运行工具生成元数据和all.go文件
      - name: Run Auto-Generation Tools
        run: |
          cd pr-branch
          # 运行 metadata.yaml 生成器
          go run github.com/meloshub/meloshub-tools/cmd/metagen@latest --output adapters.yaml
          # 运行 all.go 生成器
          go run github.com/meloshub/meloshub-tools/cmd/autoimport@latest --output ./all/all.go --pkg all

      # 运行 differ 工具生成变更报告
      - name: Generate Change Report
        id: differ
        run: |
          go run github.com/meloshub/meloshub-tools/cmd/differ@latest \
            --old ../main-branch/adapters.yaml \
            --new ./pr-branch/adapters.yaml \
            --output ./pr-branch/changes.json

      # 自动提交两个文件的变更
      - name: Commit and push generated files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          working_directory: pr-branch 
          commit_message: "chore(ci): auto-generate adapter files"
          file_pattern: "adapters.yaml all/all.go" 
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"

      # 根据变更报告添加标签并发布评论
      - name: Add Labels and Post Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = './pr-branch/changes.json';
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;

            if (!fs.existsSync(path)) {
              console.log('Change report not found, skipping labels and comment.');
              return;
            }

            const changes = JSON.parse(fs.readFileSync(path, 'utf8'));
            
            // 动态标签

            const labelConfig = {
              'NewAdapter': { color: '0e8a16', description: 'PR adds one or more new adapters.' },       // 绿色
              'UpgradeAdapter': { color: '0075ca', description: 'PR upgrades one or more existing adapters.' }, // 蓝色
              'RemoveAdapter': { color: 'b60205', description: 'PR removes one or more adapters.' }     // 红色
            };

            // 确保标签存在的函数
            async function ensureLabelExists(name) {
              const config = labelConfig[name];
              try {
                await github.rest.issues.getLabel({ owner, repo, name });
              } catch (error) {
                if (error.status === 404) {
                  console.log(`Label '${name}' not found. Creating it...`);
                  await github.rest.issues.createLabel({ owner, repo, name, ...config });
                } else {
                  throw error;
                }
              }
            }

            const labelsToAdd = [];
            if (changes.added && changes.added.length > 0) {
              labelsToAdd.push('NewAdapter');
            }
            if (changes.updated && changes.updated.length > 0) {
              labelsToAdd.push('UpgradeAdapter');
            }
            if (changes.removed && changes.removed.length > 0) {
              labelsToAdd.push('RemoveAdapter');
            }

            if (labelsToAdd.length > 0) {
              // 确保所有需要的标签都存在
              for (const labelName of labelsToAdd) {
                await ensureLabelExists(labelName);
              }
              // 为PR添加标签
              await github.rest.issues.addLabels({ owner, repo, issue_number, labels: labelsToAdd });
              console.log(`Added labels: ${labelsToAdd.join(', ')}`);
            }
            
            // --- 评论生成与发布逻辑 ---

            let body = '### 🤖 Meloshub Adapter Change Report\n\n';
            let hasChanges = false;

            if (changes.added && changes.added.length > 0) {
              hasChanges = true;
              body += '#### ✨ New Adapters\n';
              for (const a of changes.added) {
                body += `- **${a.title}** (ID: \`${a.id}\`, Version: \`${a.version}\`)\n`;
              }
            }

            if (changes.updated && changes.updated.length > 0) {
              hasChanges = true;
              body += '#### ⬆️ Upgraded Adapters\n';
              for (const u of changes.updated) {
                body += `- **${u.after.title}** (ID: \`${u.after.id}\`)\n`;
                body += `  - Version: \`${u.before.version}\` → \`${u.after.version}\`\n`;
              }
            }

            if (changes.removed && changes.removed.length > 0) {
              hasChanges = true;
              body += '#### 🗑️ Removed Adapters\n';
              for (const r of changes.removed) {
                body += `- **${r.title}** (ID: \`${r.id}\`)\n`;
              }
            }

            if (!hasChanges) {
              body += '✅ No changes detected in adapter metadata.';
            }

            await github.rest.issues.createComment({ owner, repo, issue_number, body });